/**
  * otho.js v0.1.0
  * Created by Louie Colgan (@ljbc1994)
  * Released under the MIT License.
  */
(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.Otho=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _promise=require("../utils/promise");var _promise2=_interopRequireDefault(_promise);var _isArray=require("../utils/is-array");var _isArray2=_interopRequireDefault(_isArray);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var DeferredImage=function(){_createClass(DeferredImage,null,[{key:"wait",value:function wait(src,loaded){if(!(0,_isArray2.default)(src)){src=[src]}var noImages=src.length;var images=[];var usePromise=_promise2.default!==undefined;var tempLoaded=function tempLoaded(){noImages--;if(noImages===0&&!usePromise){loaded()}};for(var i=0;i<src.length;i++){var deferred=new DeferredImage({src:src[i],loaded:tempLoaded.bind(this),failed:tempLoaded.bind(this)});if(usePromise){images.push(deferred.$promise)}}return usePromise?_promise2.default.type.all(images):null}}]);function DeferredImage(_ref){var src=_ref.src,loaded=_ref.loaded,failed=_ref.failed;_classCallCheck(this,DeferredImage);this.src=src;this.pseudo=new Image;this._loaded=loaded||function(){};this._failed=failed||function(){};this.init()}_createClass(DeferredImage,[{key:"init",value:function init(){var self=this;self.pseudo.src=this.src;self.pseudo.addEventListener("load",this._loaded);self.pseudo.addEventListener("error",this._failed);if(_promise2.default!==undefined){this.$promise=_promise2.default.instance(function(resolve,reject){self.pseudo.addEventListener("load",resolve);self.pseudo.addEventListener("error",reject)})}}}]);return DeferredImage}();exports.default=DeferredImage},{"../utils/is-array":9,"../utils/promise":13}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _watcher=require("./watcher");var _watcher2=_interopRequireDefault(_watcher);var _deferredImage=require("./deferred-image");var _deferredImage2=_interopRequireDefault(_deferredImage);var _promise=require("../utils/promise");var _promise2=_interopRequireDefault(_promise);var _isArray=require("../utils/is-array");var _isArray2=_interopRequireDefault(_isArray);var _isFunction=require("../utils/is-function");var _isFunction2=_interopRequireDefault(_isFunction);var _isNodeList=require("../utils/is-node-list");var _isNodeList2=_interopRequireDefault(_isNodeList);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Handler=function(){function Handler(_ref){var els=_ref.els,error=_ref.error,placehold=_ref.placehold,forcePlacehold=_ref.forcePlacehold,imageLoaded=_ref.imageLoaded,imageLoading=_ref.imageLoading,sync=_ref.sync,inView=_ref.inView,background=_ref.background,success=_ref.success,fail=_ref.fail,progress=_ref.progress,loaded=_ref.loaded;_classCallCheck(this,Handler);this.els=this._getElements(els);this.error=error;this.placehold=placehold;this.sync=sync;this.inView=inView;this.background=background;this.forcePlacehold=forcePlacehold;this.imageLoaded=imageLoaded;this.imageLoading=imageLoading;this.watchers=[];this.fail=fail||function(){};this.loaded=loaded||function(){};this.success=success||function(){};this.progress=progress||function(){}}_createClass(Handler,[{key:"_getElements",value:function _getElements(els){if((0,_isArray2.default)(els)){return els}else if((0,_isFunction2.default)(els)){return els.call(this)}else if((0,_isNodeList2.default)(els)){return Array.prototype.slice.call(els,0)}else{return[els]}}},{key:"init",value:function init(){this._attachWatchers();if(this.forcePlacehold&&(this.placehold||this.error)){var cb=_promise2.default!==undefined?function(){}:this._initWatchers.bind(this);var finished=_deferredImage2.default.wait([this.error,this.placehold],cb);if(_promise2.default!==undefined){return finished.then(this._initWatchers.bind(this))}}if(this.sync){return this._syncWatchers()}return this._initWatchers()}},{key:"_attachWatchers",value:function _attachWatchers(){var self=this;for(var i=0;i<self.els.length;i++){var watcher=new _watcher2.default({el:self.els[i],error:self.error,placehold:self.placehold,imageLoaded:self.imageLoaded,imageLoading:self.imageLoading,background:self.background,loaded:self._imageLoaded.bind(self),failed:self._imageFailed.bind(self),success:self._imagesSuccess.bind(self)});self.watchers.push(watcher)}}},{key:"_initWatchers",value:function _initWatchers(){var _this=this;var watcherInstances=this.watchers.map(function(watcher){return _this.inView?watcher.watchView():watcher.init()});if(_promise2.default!==undefined){return _promise2.default.type.all(watcherInstances)}return watcherInstances}},{key:"_syncWatchers",value:function _syncWatchers(){var watchers=Array.prototype.slice.apply(this.watchers);this.watchers.map(function(watcher){return watcher._setup()});_watcher2.default.queue(watchers.splice(0,1),function nextWatcher(){if(watchers.length){_watcher2.default.queue(watchers.splice(0,1),nextWatcher)}})}},{key:"_imageLoaded",value:function _imageLoaded(watcher){var self=this;var toLoad=self.watchers.length;var haveLoaded=self.watchers.filter(function(watcher){return watcher.hasLoaded}).length;self.loaded(watcher);self.progress(watcher,{total:toLoad,loaded:haveLoaded,percent:Math.round(haveLoaded/toLoad*100)});if(toLoad===haveLoaded){self._imagesSuccess()}}},{key:"_imageFailed",value:function _imageFailed(watcher){var self=this;self.fail(watcher);self._watchUpdates()}},{key:"_imagesSuccess",value:function _imagesSuccess(){var self=this;self.success(self.watchers);self._watchUpdates()}},{key:"_watchUpdates",value:function _watchUpdates(){var self=this;window.addEventListener("resize",function(){self.watchers.filter(function(watcher){return watcher.hasBackground&&watcher.hasChanged()}).forEach(function(watcher){return watcher.updateBackground()})})}},{key:"update",value:function update(){this.watchers.filter(function(watcher){return watcher.toLoad!==watcher.img.src&&!watcher.hasBackground}).forEach(function(watcher){return watcher.init()})}}]);return Handler}();exports.default=Handler},{"../utils/is-array":9,"../utils/is-function":10,"../utils/is-node-list":12,"../utils/promise":13,"./deferred-image":1,"./watcher":3}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _promise=require("../utils/promise");var _promise2=_interopRequireDefault(_promise);var _isArray=require("../utils/is-array");var _isArray2=_interopRequireDefault(_isArray);var _isImage=require("../utils/is-image");var _isImage2=_interopRequireDefault(_isImage);var _inView=require("../utils/in-view");var _inView2=_interopRequireDefault(_inView);var _domTraversal=require("../utils/dom-traversal");var _styleManipulation=require("../utils/style-manipulation");var _deferredImage=require("./deferred-image");var _deferredImage2=_interopRequireDefault(_deferredImage);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Watcher=function(){_createClass(Watcher,null,[{key:"queue",value:function queue(watchers,loaded){if(!(0,_isArray2.default)(watchers)){watchers=[watchers]}var noWatchers=watchers.length;var tempLoaded=function tempLoaded(){noWatchers--;if(noWatchers===0){loaded()}};for(var i=0;i<noWatchers;i++){var currentWatcher=watchers[i];currentWatcher._any=tempLoaded.bind(this);currentWatcher.init(true)}}}]);function Watcher(_ref){var el=_ref.el,error=_ref.error,placehold=_ref.placehold,loaded=_ref.loaded,failed=_ref.failed,imageLoaded=_ref.imageLoaded,imageLoading=_ref.imageLoading,background=_ref.background;_classCallCheck(this,Watcher);this.el=el;this.error=this.el.getAttribute("data-o-error")||error;this.background=this.el.getAttribute("data-o-background")||background;this.placehold=this.el.getAttribute("data-o-placehold")||placehold;this.imageLoaded=this.el.getAttribute("data-o-loaded")||imageLoaded;this.imageLoading=this.el.getAttribute("data-o-loading")||imageLoading;this.loaded=loaded;this.failed=failed}_createClass(Watcher,[{key:"init",value:function init(reinit){if(!reinit)this._setup();(0,_styleManipulation.addClass)(this.el,this.imageLoading);this.pseudo=new _deferredImage2.default({src:this.toLoad,loaded:this._loaded.bind(this),failed:this._error.bind(this)});if(_promise2.default!==undefined){return this.pseudo.$promise}return this}},{key:"_setup",value:function _setup(){this.pseudo={};this.inView=false;this.hasLoaded=false;this.hasBackground=false;this._getElement(this.el);this.toLoad=this._getImage();this._setImage(this.placehold);(0,_styleManipulation.removeClass)(this.el,this.imageLoaded,this.imageLoading)}},{key:"watchView",value:function watchView(){this._setup();window.addEventListener("scroll",this._onViewChange.bind(this));window.addEventListener("resize",this._onViewChange.bind(this));return this._onViewChange()}},{key:"hasChanged",value:function hasChanged(){return this.toLoad!==(0,_styleManipulation.getBackgroundImage)(this.img)}},{key:"_onViewChange",value:function _onViewChange(){if(!(0,_inView2.default)(this.el)||this.inView){return}window.removeEventListener("scroll",this._onViewChange.bind(this));window.removeEventListener("resize",this._onViewChange.bind(this));this.init(true);this.inView=true}},{key:"_getElement",value:function _getElement(el){this.img=(0,_isImage2.default)(el)||this.background?el:(0,_domTraversal.findClosestImage)(el)}},{key:"_setImage",value:function _setImage(src){if(this.background){(0,_styleManipulation.setBackgroundImage)(this.img,src)}else{this.img.src=src}}},{key:"_getImage",value:function _getImage(){return this.background?(0,_styleManipulation.getBackgroundImage)(this.img):this.img.getAttribute("data-o-src")}},{key:"_loaded",value:function _loaded(){(0,_styleManipulation.removeClass)(this.el,this.imageLoading);(0,_styleManipulation.addClass)(this.el,this.imageLoaded);this._setImage(this.toLoad);this.hasLoaded=true;this.loaded(this);this._any(this)}},{key:"_error",value:function _error(){(0,_styleManipulation.removeClass)(this.el,this.imageLoading);this._setImage(this.error);this.hasLoaded=true;this.failed(this);this._any(this)}},{key:"_any",value:function _any(){return this}}]);return Watcher}();exports.default=Watcher},{"../utils/dom-traversal":6,"../utils/in-view":8,"../utils/is-array":9,"../utils/is-image":11,"../utils/promise":13,"../utils/style-manipulation":14,"./deferred-image":1}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default={els:document.getElementsByTagName("img"),error:"",placehold:"",forcePlacehold:false,inView:false,background:false,sync:false,imageLoaded:"o-image-loaded",imageLoading:"o-image-loading"}},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.load=load;var _handler=require("./components/handler");var _handler2=_interopRequireDefault(_handler);var _options=require("./config/options");var _options2=_interopRequireDefault(_options);var _extend=require("./utils/extend");var _extend2=_interopRequireDefault(_extend);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function load(userOptions){var options=(0,_extend2.default)(_options2.default,userOptions);return new _handler2.default(options).init()}},{"./components/handler":2,"./config/options":4,"./utils/extend":7}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.findClosestImage=exports.findChildrenImages=undefined;var _isImage=require("./is-image");var _isImage2=_interopRequireDefault(_isImage);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function findChildrenImages(el){var _images=[];(function _find(el){if((0,_isImage2.default)(el)){return _images.push(el)}return Array.prototype.slice.apply(el.childNodes).forEach(_find)})(el);return _images}function findClosestImage(el){var _images=findChildrenImages(el);return _images.length?_images[0]:null}exports.findChildrenImages=findChildrenImages;exports.findClosestImage=findClosestImage},{"./is-image":11}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=extend;function extend(){var extended={},deep=false,i=0,length=arguments.length;if(Object.prototype.toString.call(arguments[0])==="[object Boolean]"){deep=arguments[0];i++}var merge=function merge(obj){for(var prop in obj){if(Object.prototype.hasOwnProperty.call(obj,prop)){if(deep&&Object.prototype.toString.call(obj[prop])==="[object Object]"){extended[prop]=extend(true,extended[prop],obj[prop])}else{extended[prop]=obj[prop]}}}};for(;i<length;i++){merge(arguments[i])}return extended}},{}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=inView;function inView(el){var rect=el.getBoundingClientRect();var doc=document.documentElement;return rect.top>=0&&rect.left>=0&&rect.bottom<=(window.innerHeight||doc.clientHeight)&&rect.right<=(window.innerWidth||doc.clientWidth)}},{}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=isArray;function isArray(el){return Object.prototype.toString.call(el)==="[object Array]"}},{}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=isFunction;function isFunction(el){return!!(el&&el.constructor&&el.call&&el.apply)}},{}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=isImage;function isImage(el){return el.nodeName.toLowerCase()==="img"}},{}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.default=isNodeList;function isNodeList(nodes){var stringRepr=Object.prototype.toString.call(nodes);return(typeof nodes==="undefined"?"undefined":_typeof(nodes))==="object"&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(stringRepr)&&typeof nodes.length==="number"&&(nodes.length===0||_typeof(nodes[0])==="object"&&nodes[0].nodeType>0)}},{}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function hasNativeSupport(){return typeof Promise!=="undefined"&&Promise.toString().indexOf("[native code]")!==-1}exports.default=function getSupportedPromise(){var _Promise=void 0,lib=void 0;if(hasNativeSupport()){_Promise=Promise}else if((lib=window.jQuery||window.Zepto)&&lib.promise!==null){_Promise=lib.promise}else if(window.Q!==null){_Promise=window.Q}if(_Promise!==null){return{instance:function instance(fn){return hasNativeSupport()?new _Promise(fn):_Promise(fn)},type:_Promise}}else{return undefined}}()},{}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.addClass=addClass;exports.removeClass=removeClass;exports.getBackgroundImage=getBackgroundImage;exports.setBackgroundImage=setBackgroundImage;function addClass(el){var toAdd=Array.prototype.slice.call(arguments,1);var classes=el.className.split(" ");if(toAdd.length===0){throw new Error("You need to provide at least one class")}el.className=classes.concat(toAdd).join(" ").trim()}function removeClass(el){var toRemove=Array.prototype.slice.call(arguments,1);if(toRemove.length===0){throw new Error("You need to provide at least one class")}el.className=el.className.split(" ").filter(function(className){return toRemove.indexOf(className)===-1}).join(" ").trim()}function getBackgroundImage(el){var background=window.getComputedStyle(el,null).getPropertyValue("background");var urlIndex=background.indexOf("url(")+4;var endIndex=background.slice(urlIndex).indexOf(")");return background.slice(urlIndex).slice(0,endIndex).replace(/["|']/g,"")}function setBackgroundImage(el,src){el.style.backgroundImage="url("+src+")"}},{}]},{},[5])(5)});
